#!/bin/bash

# seems to work great with pichunter.com
# 1 http://galleries.pichunter.com/krawl/183/1833542/index.html

showhelp() { cat<<end
1 -h
1 -v
1 -d debug url
1 url [template]
1 -l [template]
end
exit 0
}
showversion() { cat<<end
1 version 0.1 (meaningless version number)
Sun Jan 31 02:59:44 UTC 2010
http://github.com/dlight/my-tools/raw/master/bin/1
end
exit 0
}

withdefault() {
	[[ -n "$1" ]] && echo "$1" || echo "noname"
}

case "$1" in
	-h) showhelp;;
	-v) showversion;;
	-d) mode="debug"
		[[ -z "$3" ]] && showhelp
		debug="$2"
		url_once="$3";;
	-l) mode="loop"
		base="$(withdefault $1)";;
	*) mode="once"
		[[ -z "$1" ]] && showhelp;
		url_once="$1"
		base="$(withdefault $1)";;
esac

mytemp() {
	((i=1));
	while fn="$base.$i.html"; [[ -e "$fn" ]]; do
		((i++))
	done
	touch "$fn"
	echo "$fn"
}

first_pass() {
	sed -r -e '/<a href="[^>"]+"><img [^>]+><\/a>/!d
		s|<a href="([^>"]+)"><img ([^>]+)></a>|\1\n\2|
		s/ *([^=]+)="([^"]+)"/\1 \2\n/g'
}
second_pass() {
	awk 'BEGIN { RS = "\n\n+" };
		{ print "<img src=\"" $1 "\">" }'
}

content() {
	echo "$1" | first_pass | second_pass
}

header() {
	url="$1"
	data="$2"

	comment() {
		printf '<!\055\055 %s \055\055>\n' "$1"
	}

	comment "generated by 1"
	comment "from $url"
	comment "on $(date)"
	echo

	comment $'version:\n\n'"$(showversion)"$'\n'
	echo

	comment $'raw:\n\n'"$(echo "$data" | \
			sed $'s/\055\055/\&lt;\&lt;(risos)/g')"$'\n'
	echo

	comment $'parser:\n\n$0\n'"$(< $0)"$'\n'
	echo
}

doit() {
	url="$1"

	data="$(wget -q -O - "$url")"
	pagelinks="$(content "$data")"

	filename="$(mytemp)"

	header "$url" "$data" >> "$filename"
	echo "$pagelinks" >> "$filename"

	echo "$name" "($(echo "$pagelinks" | wc -l))"
}

debug() {
	data="$(wget -q -O - "$url_once")"

	case $1 in
		url) echo "$data";;
		first_pass) echo "$data"; echo "$data" | first_pass;;
		content) content "$data";;
	esac
}

loop() {
	while read i; do
		doit "$i"
	done
}

case $mode in
	debug) debug "$debug" "$url_once";;
	loop) loop;;
	once) doit "$url_once";;
esac
