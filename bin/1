#!/bin/bash

url="$1"
shift

[[ -n "$1" ]] && base="$1" || base="noname"
shift 

mytemp() {
	((i=1));
	while fn="$1.$i.html"; [[ -e "$fn" ]];
		do ((i++)); done
	touch "$fn"
	echo "$fn"
}

data="$(wget -q -O - "$url")"

name="$(mytemp "$base")"

comment() {
	printf '<!\055\055 %s \055\055>\n' "$1" >> "$name"
}

comment "generated by 1"
comment "from $url"
comment "on $(date)"
echo >> "$name"

#comment $'\nraw:\n\n'"$(echo "$data" | \
#		sed $'s/\055\055/&lt;&lt;(risos)/g'>"$'\n'
#echo >> "$name"

#comment $'\nparser:\n\n$0\n'"$0"$'\n'
#echo >> "$name"

echo "$data" | \
	sed -r -e '/<a href="[^>"]+"><img [^>]+><\/a>/!d
		s|<a href="([^>"]+)"><img ([^>]+)></a>|\1\n\2|
		s/ *([^=]+)="([^"]+)"/\1 \2\n/g' | \
	awk 'BEGIN { RS = "\n\n+" };
		{ print "<img src=\"" $1 "\">" }' > "$name"

echo 
