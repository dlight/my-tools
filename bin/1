#!/bin/bash

showhelp() {
	echo $'1 -h\n1 url [template]\n1 -l [template]'
	exit 0
}
withdefault() {
	[[ -n "$1" ]] && echo "$1" || echo "noname"
}

if [[ "$1" == "-h" ]]; then
	showhelp
elif [[ "$1" == "-l" ]]; then
	base="$(withdefault "$1")"
	mode="loop"
else
	[[ -z "$1" ]] && showhelp
	url_param="$1"
	base="$(withdefault "$2")"
	mode="once"
fi

mytemp() {
	((i=1));
	while fn="$base.$i.html"; [[ -e "$fn" ]]; do
		((i++))
	done
	touch "$fn"
	echo "$fn"
}


doit() {
	url="$1"

	data="$(wget -q -O - "$url")"

	name="$(mytemp)"

	comment() {
		printf '<!\055\055 %s \055\055>\n' "$1" >> "$name"
	}

	comment "generated by 1"
	comment "from $url"
	comment "on $(date)"
	echo >> "$name"

	comment $'raw:\n\n'"$(echo "$data" | \
			sed $'s/\055\055/\&lt;\&lt;(risos)/g')"$'\n'
	echo >> "$name"

	comment $'parser:\n\n$0\n'"$(< $0)"$'\n'
	echo >> "$name"

	echo "$data" | \
		sed -r -e '/<a href="[^>"]+"><img [^>]+><\/a>/!d
			s|<a href="([^>"]+)"><img ([^>]+)></a>|\1\n\2|
			s/ *([^=]+)="([^"]+)"/\1 \2\n/g' | \
		awk 'BEGIN { RS = "\n\n+" };
			{ print "<img src=\"" $1 "\">" }' >> "$name"

	echo "$name"
}

loop() {
	while read i; do
		doit "$i"
	done
}

